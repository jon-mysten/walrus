"use strict";(globalThis.webpackChunkwalrus_docusaurus=globalThis.webpackChunkwalrus_docusaurus||[]).push([[2458],{272(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});let s=JSON.parse('{"id":"operator-guide/upload-relay","title":"The Walrus Upload Relay","description":"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems.","source":"@site/../content/operator-guide/upload-relay.mdx","sourceDirName":"operator-guide","slug":"/operator-guide/upload-relay","permalink":"/docs/operator-guide/upload-relay","draft":false,"unlisted":false,"editUrl":"https://github.com/MystenLabs/walrus/tree/main/docs/../content/operator-guide/upload-relay.mdx","tags":[],"version":"current","frontMatter":{"title":"The Walrus Upload Relay","description":"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems."},"sidebar":"operatorSidebar","previous":{"title":"Backup and Restore Guide","permalink":"/docs/operator-guide/backup-restore-guide"}}');var i=t(2615),r=t(5756);let o={title:"The Walrus Upload Relay",description:"Complete guide to operating Walrus upload relays for facilitating browser-based blob storage with tip configuration and payment systems."},l,a={},d=[{value:"Design",id:"design",level:2},{value:"Operate the upload relay",id:"operate-the-upload-relay",level:3},{value:"Pay the tip",id:"pay-the-tip",level:3},{value:"Send data to the upload relay",id:"send-data-to-the-upload-relay",level:3},{value:"Receive the certificate",id:"receive-the-certificate",level:2},{value:"Install the relay",id:"install-the-relay",level:2},{value:"Use Docker",id:"use-docker",level:3},{value:"Build from source",id:"build-from-source",level:3},{value:"Configure the relay",id:"configure-the-relay",level:2},{value:"Configure relay-specific settings",id:"configure-relay-specific-settings",level:3}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{ImportContent:t,Term:s}=n;return t||p("ImportContent",!0),s||p("Term",!0),(0,i.jsxs)(i.Fragment,{children:["\n",(0,i.jsxs)(n.p,{children:["Walrus enables dApps to store data from within their end-users' browsers having low to moderate machine specifications (mobile devices, low-powered laptops, and so on). This browser-based scenario is difficult to achieve in practice with an in-browser process that directly communicates with the ",(0,i.jsx)(s,{lookup:"Storage node",children:"storage nodes"})," due to the high number of network connections required to upload all slivers to all shards."]}),"\n",(0,i.jsxs)(n.p,{children:["The upload relay is a downloadable program that community members, Mysten Labs, and dApp writers themselves can run on internet-facing hosts to facilitate storing ",(0,i.jsx)(s,{lookup:"Blob",children:"blob"})," slivers onto the ","storage nodes"," on behalf of the end-users, thus mitigating browser resource consumption and enabling web-based store operations."]}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.p,{children:"Mysten Labs runs 2 publicly-available upload relays. You can find them at the following addresses:"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Testnet: ",(0,i.jsx)(n.code,{children:"https://upload-relay.testnet.walrus.space"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Mainnet: ",(0,i.jsx)(n.code,{children:"https://upload-relay.mainnet.walrus.space"})]}),"\n"]}),"\n"]})]}),"\n",(0,i.jsx)(n.h2,{id:"design",children:"Design"}),"\n",(0,i.jsxs)(n.p,{children:["At a high level, a ",(0,i.jsx)(s,{lookup:"Client",children:"client"})," stores a ","blob"," using an upload relay as follows:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["First, the ","client"," locally encodes the ","blob"," and registers it on Sui."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Then, the ","client"," sends the ","blob"," to the upload relay through an HTTP POST request to the ","blob","-relay endpoint ",(0,i.jsx)(n.code,{children:"/v1/blob-upload-relay"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The upload relay then encodes the ","blob",", sends the slivers to the ","storage nodes",", collects a storage confirmation certificate, and sends it back to the ","client","."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Finally, the ","client"," uses the confirmation certificate to certify the ","blob"," on Sui."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The upload relay does not perform any on-chain operation and only helps clients distribute the slivers of their ","blobs"," to ","storage nodes","."]}),"\n",(0,i.jsx)(n.p,{children:"The flow between clients and the upload relay is already implemented in the Walrus CLI, Rust SDK, and TS SDK, and therefore developers do not need to implement it themselves. For completeness, the following sections discuss how the service is implemented, paid for, and used by clients."}),"\n",(0,i.jsx)(n.h3,{id:"operate-the-upload-relay",children:"Operate the upload relay"}),"\n",(0,i.jsx)(n.p,{children:"The upload relay can be operated in 2 ways:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Free service"}),": It accepts simple HTTP POST requests with ","blobs"," from clients, and relays them to the ","storage nodes"," for free."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Paid service"})," for public relays: In this configuration, the upload relay requires a tip to relay a ","blob",". The tip can be used by the relay operator to cover the costs of running the infrastructure and turn a profit on the service. At the moment, a constant tip and a tip that is linear in the unencoded data size are allowed."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Upload relays expose a tip-configuration endpoint ",(0,i.jsx)(n.code,{children:"/v1/tip-config"})," that returns the tipping configuration. For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "send_tip": {\n    "address": "0x1234...",\n    "kind": {\n    "const": 105\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The configuration above specifies that every store operation requires a tip of ",(0,i.jsx)(n.code,{children:"105 MIST"})," (arbitrary value), paid to the set address ",(0,i.jsx)(n.code,{children:"0x1234.."}),". This configuration is provided even for free upload relays that return ",(0,i.jsx)(n.code,{children:'"no_tip"'}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"pay-the-tip",children:"Pay the tip"}),"\n",(0,i.jsx)(n.p,{children:"This step is only necessary if the relay requires a tip."}),"\n",(0,i.jsxs)(n.p,{children:["To pay the tip, the ","client"," proceeds as follows:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["It computes the ",(0,i.jsx)(n.code,{children:"blob_digest = SHA256(blob)"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["It generates a random ",(0,i.jsx)(n.code,{children:"nonce"}),", and hashes it ",(0,i.jsx)(n.code,{children:"nonce_digest = SHA256(nonce)"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["It computes the ",(0,i.jsx)(n.code,{children:"unencoded_length = blob.len()"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Then, it creates a ",(0,i.jsx)(n.a,{href:"https://docs.sui.io/concepts/transactions/prog-txn-blocks",children:"programmable transaction block (PTB)"}),", where the first input ",(0,i.jsx)(n.code,{children:"0"})," is the ",(0,i.jsx)(n.code,{children:"bcs"})," encoded representation of ",(0,i.jsx)(n.code,{children:"blob_digest || nonce_digest || unencoded_length"}),". This is later used by the relay to authenticate the sender of the store request. In the same PTB, the ","client"," transfers the appropriate tip amount to the relay's wallet . This can also be found through the ",(0,i.jsx)(n.code,{children:"/v1/tip-config"})," endpoint. Usually, the ","client"," also registers the ","blob"," in this transaction. This is not mandatory, and the ","blob"," can be registered in another transaction, but it is commonly convenient and cheaper to perform all these operations together."]}),"\n",(0,i.jsxs)(n.p,{children:["After the transaction is executed, the ","client"," keeps the transaction ID ",(0,i.jsx)(n.code,{children:"tx_id"}),", the ",(0,i.jsx)(n.code,{children:"nonce"}),", and the ",(0,i.jsx)(n.code,{children:"blob_id"}),", which are required for the next phase."]}),"\n",(0,i.jsx)(n.p,{children:"The relay enforces a freshness check on the transaction that paid the tip, currently 1 hour by default, but each relay can independently configure this."}),"\n",(0,i.jsx)(n.h3,{id:"send-data-to-the-upload-relay",children:"Send data to the upload relay"}),"\n",(0,i.jsxs)(n.p,{children:["See the full ",(0,i.jsx)(n.a,{href:"https://github.com/mystenlabs/walrus/tree/main/crates/walrus-upload-relay/upload_relay_openapi.html",children:"OpenAPI spec"})," for the upload relay for the full details."]}),"\n",(0,i.jsxs)(n.p,{children:["Essentially, the ","client"," sends a POST request to the ",(0,i.jsx)(n.code,{children:"/v1/blob-upload-relay"})," API endpoint on the relay, containing the bytes of the ","blob"," to be stored in the body."]}),"\n",(0,i.jsx)(n.p,{children:"These additional parameters have to be specified in the URL's query string:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"blob_id"})}),": Required. The ",(0,i.jsx)(s,{lookup:"Blob ID",children:"blob ID"})," of the ","blob"," to be stored. Example: ",(0,i.jsx)(n.code,{children:"blob_id=E7_nNXvFU_3qZVu3OH1yycRG7LZlyn1-UxEDCDDqGGU"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"tx_id*"})}),": Required if the relay requires a tip. The transaction ID (base58 encoded) of the transaction that transferred the ",(0,i.jsx)(n.code,{children:"tip"})," to the relay. Example: ",(0,i.jsx)(n.code,{children:"tx_id=EmcFpdozbobqH61w76T4UehhC4UGaAv32uZpv6c4CNyg"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"nonce"})}),": Required if the relay requires a tip. The ",(0,i.jsx)(n.code,{children:"nonce"}),", the pre-image of the hash added to the transaction inputs created above, as a base64 URL-encoded string without padding. Example: ",(0,i.jsx)(n.code,{children:"nonce=rw8xIuqxwMpdOcF_3jOprsD9TtPWfXK97tT_lWr1teQ"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"deletable_blob_object"})}),": Required if the ","blob"," is registered as deletable. If the ","blob"," being stored is deletable, then the ","client"," must specify the object ID as a hexadecimal string of the ","blob",". If the ","blob"," is to be stored as a permanent one, this parameter should not be specified. Example: ",(0,i.jsx)(n.code,{children:"deletable_blob_object=0x56ae1c86e17db174ea002f8340e28880bc8a8587c56e8604a4fa6b1170b23a60"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"encoding_type"})}),": Optional. The encoding type to be used for the ","blob",". The default value, and at the moment the only value, is ",(0,i.jsx)(n.code,{children:"RS2"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"receive-the-certificate",children:"Receive the certificate"}),"\n",(0,i.jsxs)(n.p,{children:["After the relay is done storing the ","blob",", it collects the confirmation certificate from the ","storage nodes","."]}),"\n",(0,i.jsxs)(n.p,{children:["Then, it sends a response to the ","client",", containing the ",(0,i.jsx)(n.code,{children:"blob_id"})," of the stored ","blob"," along with the ",(0,i.jsx)(n.code,{children:"confirmation_certificate"}),". The ","client"," can then use this certificate to certify the ","blob"," on chain."]}),"\n",(0,i.jsx)(n.h2,{id:"install-the-relay",children:"Install the relay"}),"\n",(0,i.jsxs)(n.p,{children:["If you'd like to download a pre-built binary to manually run ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"}),", you need to download it from ",(0,i.jsx)(n.a,{href:"https://github.com/MystenLabs/walrus/releases",children:"the releases page"}),". ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"})," does not daemonize itself, and requires some supervisor process to ensure boot at startup, to restart in the event of failures, and so on."]}),"\n",(0,i.jsx)(n.h3,{id:"use-docker",children:"Use Docker"}),"\n",(0,i.jsxs)(n.p,{children:["The docker image for ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"})," is available on Docker Hub as ",(0,i.jsx)(n.code,{children:"mysten/walrus-upload-relay"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"$ docker run -it --rm mysten/walrus-upload-relay --help\n"})}),"\n",(0,i.jsx)(n.h3,{id:"build-from-source",children:"Build from source"}),"\n",(0,i.jsxs)(n.p,{children:["The sources for the ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"})," are available on ",(0,i.jsx)(n.a,{href:"https://github.com/MystenLabs/walrus",children:"GitHub"})," in the ",(0,i.jsx)(n.code,{children:"crates/walrus-upload-relay"})," subdirectory. Run the following from the root of the Walrus repo:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"$ cargo build --release --bin walrus-upload-relay\n./target/release/walrus-upload-relay --help\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configure-the-relay",children:"Configure the relay"}),"\n",(0,i.jsx)(n.p,{children:"Below is an example of how you might place the configuration such that it is reachable when invoking Docker to run the relay. For the sake of the example below, the following assumptions are made:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"$HOME/.config/walrus/walrus_upload_relay_config.yaml"})," exists on the host machine and contains the configuration for the ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"}),", as described ",(0,i.jsx)(n.a,{href:"#configure-relay-specific-settings",children:"in the configuration section"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"$HOME/.config/walrus/client_config.yaml"})," exists on the host machine and contains ","Walrus client"," configuration as specified ",(0,i.jsx)(n.a,{href:"/docs/getting-started/advanced-setup#configuration",children:"in the CLI setup section"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Port 3000 is available for the relay to bind to. Change this to whichever port you'd like to expose from your host."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"$ docker run \\\n    -p 3000:3000 \\\n    -v $HOME/.config/walrus/walrus_upload_relay_config.yaml:/opt/walrus/walrus_upload_relay_config.yaml \\\n    -v $HOME/.config/walrus/client_config.yaml:/opt/walrus/client_config.yaml \\\n    mysten/walrus-upload-relay \\\n    --context testnet \\\n    --walrus-config /opt/walrus/client_config.yaml \\\n    --server-address 0.0.0.0:3000 \\\n    --relay-config /opt/walrus/walrus_upload_relay_config.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configure-relay-specific-settings",children:"Configure relay-specific settings"}),"\n",(0,i.jsxs)(n.p,{children:["Here is an example of the ",(0,i.jsx)(n.code,{children:"walrus-upload-relay"})," configuration file:"]}),"\n",(0,i.jsx)(t,{source:"/crates/walrus-upload-relay/walrus_upload_relay_config_example.yaml",mode:"code"}),"\n",(0,i.jsx)(n.p,{children:"Currently, the options are the following:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tip_config"}),": The configuration for the tip to be paid. It can be ",(0,i.jsx)(n.code,{children:"!no_tip"}),", for the free service, or ",(0,i.jsx)(n.code,{children:"!send_tip"}),", to configure the requested tip. In that case, ",(0,i.jsx)(n.code,{children:"address"})," contains the hex-encoded address of the upload relay owner, where the tip should be sent to, and ",(0,i.jsx)(n.code,{children:"kind"})," is the kind of tip that should be paid. It can be ",(0,i.jsx)(n.code,{children:"!const"}),", for a constant tip for each store, or ",(0,i.jsx)(n.code,{children:"!linear"}),", for a tip that is linear in the unencoded ","blob"," size."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tx_freshness_threshold_secs"}),": The maximum amount of time in seconds for which a transaction that pays the tip is considered valid."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tx_max_future_threshold_secs"}),": The maximum amount of time in the future for which the tip-paying transaction is considered valid. This is simply to account for some clock skew."]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}function p(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},5756(e,n,t){t.d(n,{R:()=>o,x:()=>l});var s=t(9471);let i={},r=s.createContext(i);function o(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);